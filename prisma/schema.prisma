// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model TelegramUser {
  id        BigInt   @id @default(autoincrement())
  tgId      BigInt   @unique @map("tg_id")
  username  String?  @db.VarChar(255)
  firstName String?  @map("first_name") @db.VarChar(255)
  photoUrl  String?  @map("photo_url") @db.VarChar(500)
  language  String   @default("en") @db.VarChar(10)
  createdAt DateTime @default(now()) @map("created_at")

  spaceMembers         SpaceMember[]
  createdSpaces        Space[]                   @relation("SpaceOwner")
  userStats            UserSpaceStats[]
  stories              Story[]
  pokesFrom            Poke[]                    @relation("PokeFrom")
  pokesTo              Poke[]                    @relation("PokeTo")
  notificationSettings UserNotificationSettings?

  @@map("users")
}

model Space {
  id          BigInt   @id @default(autoincrement())
  name        String   @db.VarChar(255)
  ownerUserId BigInt   @map("owner_user_id")
  timezone    String   @default("Europe/Berlin") @db.VarChar(100)
  avatarUrl   String?  @map("avatar_url") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  owner     TelegramUser     @relation("SpaceOwner", fields: [ownerUserId], references: [id], onDelete: Cascade)
  members   SpaceMember[]
  invites   Invite[]
  tasks     Task[]
  goals     Goal[]
  userStats UserSpaceStats[]
  rewards   Reward[]
  levelRequirements LevelRequirement[]
  stories   Story[]
  pokes     Poke[]

  @@map("spaces")
}

enum Role {
  Admin
  Editor
  Viewer
}

model SpaceMember {
  spaceId  BigInt   @map("space_id")
  userId   BigInt   @map("user_id")
  role     Role
  joinedAt DateTime @default(now()) @map("joined_at")

  space Space        @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  user  TelegramUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([spaceId, userId])
  @@map("space_members")
}

model Invite {
  id        BigInt   @id @default(autoincrement())
  spaceId   BigInt   @map("space_id")
  role      Role
  code      String   @unique @db.VarChar(50)
  expiresAt DateTime @map("expires_at")
  createdBy BigInt   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")

  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@map("invites")
}

model Task {
  id                BigInt    @id @default(autoincrement())
  spaceId           BigInt    @map("space_id")
  title             String    @db.VarChar(500)
  description       String?   @map("description") @db.Text
  difficulty        Int       @default(1)
  xp                Int       @default(0)
  recurrenceType    String?   @map("recurrence_type") @db.VarChar(50)
  recurrencePayload Json?     @map("recurrence_payload")
  dueAt             DateTime? @map("due_at")
  dueHasTime        Boolean   @default(true) @map("due_has_time")
  reminderSent      Boolean   @default(false) @map("reminder_sent")
  isPaused          Boolean   @default(false) @map("is_paused")
  createdBy         BigInt    @map("created_by")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@index([spaceId, dueAt])
  @@index([spaceId, isPaused])
  @@map("tasks")
}

model Goal {
  id         BigInt   @id @default(autoincrement())
  spaceId    BigInt   @map("space_id")
  title      String   @db.VarChar(500)
  difficulty Int      @default(1)
  xp         Int      @default(0)
  isDone     Boolean  @default(false) @map("is_done")
  assigneeUserId BigInt? @map("assignee_user_id")
  assigneeScope  String  @default("space") @map("assignee_scope") @db.VarChar(20)
  targetType     String  @default("unlimited") @map("target_type") @db.VarChar(20)
  targetYear     Int?    @map("target_year")
  targetMonth    Int?    @map("target_month")
  createdBy  BigInt   @map("created_by")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@index([spaceId, isDone])
  @@map("goals")
}

model UserSpaceStats {
  spaceId   BigInt   @map("space_id")
  userId    BigInt   @map("user_id")
  totalXp   Int      @default(0) @map("total_xp")
  level     Int      @default(1)
  updatedAt DateTime @updatedAt @map("updated_at")

  space Space        @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  user  TelegramUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([spaceId, userId])
  @@index([spaceId, totalXp])
  @@map("user_space_stats")
}

model TaskCompletion {
  id          BigInt   @id @default(autoincrement())
  taskId      BigInt   @map("task_id")
  spaceId     BigInt   @map("space_id")
  userId      BigInt   @map("user_id")
  xp          Int      @default(0)
  completedAt DateTime @default(now()) @map("completed_at")

  @@index([spaceId, userId, completedAt])
  @@index([taskId])
  @@map("task_completions")
}

model UserEngagementState {
  spaceId            BigInt   @map("space_id")
  userId             BigInt   @map("user_id")
  lastInactiveAt     DateTime? @map("last_inactive_at")
  lastBegAt          DateTime? @map("last_beg_at")
  lastSuccessAt      DateTime? @map("last_success_at")
  lastRewardAt       DateTime? @map("last_reward_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@id([spaceId, userId])
  @@map("user_engagement_state")
}

model Reward {
  spaceId BigInt
  level   Int
  text    String @db.Text

  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@id([spaceId, level])
  @@map("rewards")
}

model LevelRequirement {
  spaceId    BigInt
  level      Int
  xpRequired Int @map("xp_required")

  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@id([spaceId, level])
  @@map("level_requirements")
}

enum StoryType {
  Weekly
  Admin
}

model Story {
  id            BigInt    @id @default(autoincrement())
  spaceId       BigInt    @map("space_id")
  userId        BigInt    @map("user_id")
  type          StoryType
  data          Json // Статистика: tasksCompleted, levelsGained, leaderboardChange
  weekStartDate DateTime  @map("week_start_date") // Начало недели для которой статистика
  createdAt     DateTime  @default(now()) @map("created_at")

  space Space        @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  user  TelegramUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([spaceId, userId, weekStartDate])
  @@index([spaceId, userId, createdAt])
  @@map("stories")
}

model Poke {
  id         BigInt   @id @default(autoincrement())
  fromUserId BigInt   @map("from_user_id")
  toUserId   BigInt   @map("to_user_id")
  spaceId    BigInt   @map("space_id")
  createdAt  DateTime @default(now()) @map("created_at")

  fromUser TelegramUser @relation("PokeFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser   TelegramUser @relation("PokeTo", fields: [toUserId], references: [id], onDelete: Cascade)
  space    Space        @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@index([fromUserId, toUserId, spaceId, createdAt])
  @@index([toUserId, createdAt])
  @@map("pokes")
}

model UserNotificationSettings {
  userId               BigInt   @id @map("user_id")
  taskRemindersEnabled Boolean  @default(true) @map("task_reminders_enabled")
  reminderHoursBefore  Int      @default(2) @map("reminder_hours_before") // За сколько часов до дедлайна напоминать
  reminderTime         String   @default("18:00") @map("reminder_time") // Время напоминаний для задач без времени
  pokeEnabled          Boolean  @default(true) @map("poke_enabled") // Могут ли другие пнуть этого пользователя
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  user TelegramUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notification_settings")
}
