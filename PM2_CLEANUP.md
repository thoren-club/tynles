# Инструкция по удалению старого PM2 процесса task-bot

## Шаги для удаления старого процесса

### 1. Проверка текущих процессов PM2

Сначала проверьте, какие процессы запущены в PM2:

```bash
pm2 list
```

Или для более подробной информации:

```bash
pm2 status
```

Вы должны увидеть что-то вроде:
```
┌─────┬──────────────┬─────────────┬─────────┬─────────┬──────────┐
│ id  │ name         │ mode        │ ↺       │ status  │ cpu      │
├─────┼──────────────┼─────────────┼─────────┼─────────┼──────────┤
│ 0   │ task-bot     │ fork        │ 0       │ online  │ 0%       │
│ 1   │ other-app    │ fork        │ 5       │ online  │ 2%       │
└─────┴──────────────┴─────────────┴─────────┴─────────┴──────────┘
```

### 2. Остановка процесса task-bot

Остановите процесс (не удаляя его из списка):

```bash
pm2 stop task-bot
```

Или по ID (если знаете ID):

```bash
pm2 stop 0
```

Проверьте, что процесс остановлен:

```bash
pm2 list
```

Статус должен измениться на `stopped`.

### 3. Удаление процесса из PM2

Удалите процесс из списка PM2:

```bash
pm2 delete task-bot
```

Или по ID:

```bash
pm2 delete 0
```

Подтвердите удаление, если PM2 запросит подтверждение.

### 4. Проверка удаления

Проверьте, что процесс удален:

```bash
pm2 list
```

Процесс `task-bot` больше не должен отображаться в списке.

### 5. Сохранение конфигурации PM2

После удаления процесса сохраните текущую конфигурацию PM2:

```bash
pm2 save
```

Это удалит `task-bot` из автозапуска при перезагрузке системы.

### 6. (Опционально) Удаление логов PM2

Если хотите также удалить логи старого процесса:

```bash
# Просмотр логов (чтобы убедиться, что это правильные логи)
pm2 logs task-bot --lines 10

# Удаление логов
pm2 flush task-bot

# Или удаление всех логов
pm2 flush
```

**Внимание:** `pm2 flush` удалит все логи PM2, не только для `task-bot`.

---

## Альтернативный способ: удаление всех процессов и очистка

Если вы хотите полностью очистить PM2 и начать заново:

```bash
# Остановить все процессы
pm2 stop all

# Удалить все процессы
pm2 delete all

# Сохранить пустую конфигурацию
pm2 save

# Проверить результат
pm2 list
```

---

## Проверка автозапуска PM2

Если вы настроили автозапуск PM2 при загрузке системы, убедитесь, что старый процесс не запустится снова:

```bash
# Проверить текущую конфигурацию автозапуска
pm2 startup

# Если нужно обновить автозапуск после удаления процессов:
pm2 save
pm2 unstartup  # Удалить старую конфигурацию автозапуска
pm2 startup    # Создать новую (выполните команду, которую PM2 выведет)
pm2 save       # Сохранить текущие процессы
```

---

## Если процесс не удаляется

Если процесс не удаляется обычным способом, попробуйте:

```bash
# Принудительная остановка
pm2 stop task-bot --force

# Или убить процесс напрямую (найти PID)
pm2 list
# Использовать PID из списка
kill -9 <PID>

# Затем удалить из PM2
pm2 delete task-bot
```

---

## После удаления: настройка нового процесса

После удаления старого процесса вы можете запустить новый с правильным именем:

```bash
# Запуск нового процесса с именем telegram-task-bot
pm2 start dist/index.js --name telegram-task-bot

# Или если у вас есть ecosystem.config.js:
pm2 start ecosystem.config.js

# Сохранить конфигурацию
pm2 save
```

---

## Полезные команды PM2 для мониторинга

```bash
# Список процессов
pm2 list

# Подробная информация о процессе
pm2 describe task-bot

# Мониторинг в реальном времени
pm2 monit

# Логи процесса
pm2 logs task-bot

# Перезапуск процесса
pm2 restart task-bot

# Перезагрузка процесса (с нуля)
pm2 reload task-bot

# Информация о PM2
pm2 info
```

---

## Частые проблемы

### Проблема: "process not found"

**Решение:**
- Проверьте точное имя процесса: `pm2 list`
- Имена чувствительны к регистру
- Используйте точное имя из списка

### Проблема: процесс перезапускается после удаления

**Решение:**
```bash
# Убедитесь, что сохранили конфигурацию после удаления
pm2 delete task-bot
pm2 save

# Проверьте, нет ли скриптов автозапуска в systemd или cron
systemctl list-units | grep task-bot
crontab -l | grep task-bot
```

### Проблема: "Cannot delete process in cluster mode"

**Решение:**
```bash
# Удалите все инстансы
pm2 delete task-bot
# Или по ID каждого инстанса
pm2 delete 0 1 2 3
```

---

**Готово!** Старый процесс `task-bot` должен быть полностью удален из PM2.
