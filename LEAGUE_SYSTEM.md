# Система лиг

## Обзор

Система лиг работает аналогично Duolingo и состоит из 12 лиг. Пользователи соревнуются за позиции в лигах, получая опыт за выполнение задач в течение 30-дневного периода.

## Лиги (12 уровней)

1. **Бронзовая** (Bronze)
2. **Серебряная** (Silver)
3. **Золотая** (Gold)
4. **Сапфировая** (Sapphire)
5. **Рубиновая** (Ruby)
6. **Изумрудная** (Emerald)
7. **Аметистовая** (Amethyst)
8. **Жемчужная** (Pearl)
9. **Обсидиановая** (Obsidian)
10. **Алмазная** (Diamond)
11. **Мастер** (Master)
12. **Легендарная** (Legendary)

## Логика перехода между лигами

Каждые **30 дней** происходит пересмотр лиг. Пользователи распределяются по позициям в своей текущей лиге на основе опыта, заработанного за этот период.

### Распределение позиций в лиге:

- **Первые 10 позиций** → **переход вперёд** (в следующую лигу)
- **Следующие 30 позиций** → **остаются** в текущей лиге
- **Остальные 10 позиций** → **переход назад** (в предыдущую лигу)

**Итого:** 50 позиций в каждой лиге (10 + 30 + 10 = 50).

### Особые случаи:

- Если пользователь находится в **последней лиге** (Легендарная) и попадает в топ-10, он **остаётся** в ней.
- Если пользователь находится в **первой лиге** (Бронзовая) и попадает в последние 10, он **остаётся** в ней.

## Расчёт опыта

Опыт за 30 дней рассчитывается на основе:
- Выполненных задач в течение последних 30 дней (скользящее окно)
- Каждая задача даёт опыт (XP) на основе важности и типа

### Временное окно:

- 30 дней отсчитываются от текущей даты назад (скользящее окно)
- Опыт накапливается постоянно, а не сбрасывается

## Период лиги

- **Длительность периода:** 30 дней
- **Обновление лиг:** автоматически каждые 30 дней
- **Начало периода:** фиксируется в `leaguePeriodStart` для каждого пользователя

## Структура данных

### UserSpaceStats

```prisma
model UserSpaceStats {
  spaceId         BigInt   @map("space_id")
  userId          BigInt   @map("user_id")
  totalXp         Int      @default(0) @map("total_xp")
  level           Int      @default(1)
  currentLeague   Int      @default(1) @map("current_league") // 1-12
  leaguePeriodStart DateTime? @map("league_period_start") // Дата начала текущего периода
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // ...
}
```

### Лиги в коде

```typescript
export enum League {
  BRONZE = 1,
  SILVER = 2,
  GOLD = 3,
  SAPPHIRE = 4,
  RUBY = 5,
  EMERALD = 6,
  AMETHYST = 7,
  PEARL = 8,
  OBSIDIAN = 9,
  DIAMOND = 10,
  MASTER = 11,
  LEGENDARY = 12,
}
```

## API

### GET /api/stats/leaderboard

Возвращает лидерборд с информацией о лигах:

```json
{
  "leaderboard": [
    {
      "userId": "123",
      "username": "user1",
      "firstName": "Иван",
      "level": 5,
      "totalXp": 450,
      "league": 3,
      "leagueName": "Золотая",
      "leaguePosition": 7
    }
  ],
  "periodDays": 30
}
```

## Scheduled Task

Обновление лиг происходит автоматически каждые 30 дней через scheduled task в `src/index.ts`.

Логика обновления:
1. Получить всех пользователей пространства
2. Рассчитать опыт за последние 30 дней для каждого
3. Отсортировать по опыту (убывание)
4. Распределить по позициям в лигах
5. Применить правила перехода (10 вперёд, 30 остаются, 10 назад)
6. Обновить `currentLeague` и `leaguePeriodStart` в БД

## Будущие улучшения

- Таблица `TaskCompletion` для отслеживания точного опыта за 30 дней
- История переходов между лигами
- Уведомления о переходе в новую лигу
- Визуализация прогресса в текущей лиге
- Статистика по лигам для каждого пользователя
