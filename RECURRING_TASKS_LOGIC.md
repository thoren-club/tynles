# Текущая логика повторяющихся задач

## Как работает сейчас:

### 1. Создание задачи:
- Если выбрана галочка "повторяющаяся задача" и выбраны дни недели (ПН-ВС):
  - Если выбрано 7 дней → `recurrenceType: 'daily'`
  - Если выбрано меньше 7 дней → `recurrenceType: 'weekly'`
- `recurrencePayload: { daysOfWeek: [1,2,3...] }` - массив дней недели (0=ВС, 1=ПН, ..., 6=СБ)
- Если повторяющаяся, то `dueAt` может быть установлен при создании, но должен скрываться в UI

### 2. Выполнение задачи:
- **Одноразовая задача**: удаляется после выполнения
- **Повторяющаяся задача**: 
  - Не удаляется
  - Обновляется только `updatedAt` (используется как время последнего выполнения)
  - `dueAt` НЕ обновляется автоматически при выполнении

### 3. Отображение задачи:
- Если задача повторяющаяся и была выполнена (`updatedAt` недавно), показывается "задача станет доступна через X часов"

### 4. Сгорание задач (task-expiration.ts):
- Запускается каждый час (в начале часа)
- Находит задачи с `dueAt < now` (просроченные)
- Снимает половину XP как штраф
- Обновляет `dueAt` на следующий период через `calculateNextDueDate()`
- Сбрасывает `reminderSent: false`

## Проблемы и вопросы:

### ❓ Вопрос 1: Когда должна обновляться дата `dueAt` для повторяющихся задач?

**Варианты:**
- A) Сразу после выполнения задачи (автоматически устанавливать следующий период)
- B) В полночь каждого дня (cron job)
- C) При первом открытии задачи после выполнения (lazy update)
- D) Только через task-expiration (когда задача "сгорела")

**Текущая реализация:** Вариант D (только когда сгорела)

### ❓ Вопрос 2: Что означает `dueAt` для повторяющейся задачи?

**Варианты:**
- A) Срок выполнения текущего экземпляра задачи (за день/неделю)
- B) Дата, когда задача должна быть доступна снова (если выполнена)
- C) Не используется для повторяющихся (только для одноразовых)

**Текущая реализация:** Вариант A (срок выполнения текущего экземпляра)

### ❓ Вопрос 3: Когда задача должна "сгорать" (просрочиваться)?

**Варианты:**
- A) В полночь дня, когда должна была быть выполнена (для ежедневных)
- B) В конце недели, если не выполнена хотя бы раз (для еженедельных)
- C) В момент, когда `dueAt` < текущее время (любое время дня)
- D) В конце дня, когда `dueAt` установлен (например, 23:59)

**Текущая реализация:** Вариант C (момент, когда `dueAt` < now)

### ❓ Вопрос 4: Как должна работать еженедельная задача?

**Сценарий:** Задача повторяется в ПН, СР, ПТ (3 дня в неделю)

**Варианты:**
- A) Одна запись в БД, `dueAt` обновляется на следующий день (ПН → СР → ПТ → ПН следующей недели)
- B) Одна запись в БД, но показывается как доступная в указанные дни недели (независимо от `dueAt`)
- C) Каждый день задача сгорает в полночь, если не выполнена, и обновляется на следующий день недели

**Текущая реализация:** Вариант A (но есть проблемы с обновлением `dueAt`)

### ❓ Вопрос 5: Что должно происходить после выполнения ежедневной задачи?

**Сценарий:** Ежедневная задача выполнена сегодня в 10:00

**Варианты:**
- A) Сразу обновить `dueAt` на завтра (тот же час или полночь завтра)
- B) Обновить `dueAt` только в полночь, если задача не сгорела
- C) Показывать "доступна снова через 24 часа" без обновления `dueAt`
- D) Обновить `updatedAt`, но `dueAt` остается тем же (обновляется только при сгорании)

**Текущая реализация:** Вариант D (обновляется только `updatedAt`)

### ❓ Вопрос 6: Как определить, доступна ли задача для выполнения?

**Текущая логика в TaskDetail.tsx:**
- Если задача повторяющаяся и `updatedAt` недавно → показывать таймер "доступна через X"
- Иначе → показывать кнопку "Выполнить"

**Проблема:** Не учитывается `dueAt` и дни недели для еженедельных задач

### ❓ Вопрос 7: Штраф за несделанную задачу (-50% XP)

**Вопросы:**
- A) Штраф должен применяться один раз или каждый день, пока задача не выполнена?
- B) Для еженедельной задачи - штраф за каждый день из дней недели, когда не выполнена, или один раз за неделю?
- C) Если задача выполнена после сгорания, штраф все равно применяется?

### ❓ Вопрос 8: Нужен ли дедлайн для повторяющихся задач?

**Варианты:**
- A) Нет, дедлайн только для одноразовых задач
- B) Да, но это дедлайн для текущего экземпляра (например, "выполнить до конца дня")
- C) Да, это общий дедлайн для всей серии задач (например, "повторять до 31 декабря")

**Текущая реализация:** Вариант B, но UI скрывает поле дедлайна для повторяющихся

---

## Рекомендации для идеального решения:

Опишите ваше видение идеальной логики, и я реализую её! Особенно важно:
1. Когда обновляется `dueAt` после выполнения
2. Как работает штраф (когда применяется)
3. Как определяется доступность задачи
4. Что делать с задачами без дедлайна
