# Информация о лидербордах

## Глобальный лидерборд

**Кто отображается:**
- Все пользователи, которые когда-либо выполняли задачи в любом пространстве
- Пользователи сортируются по максимальному общему опыту (totalXp) среди всех пространств
- Пользователи разделяются на **чанки по 50 пользователей**
- Отображаются только пользователи, у которых есть хотя бы одна запись в `UserSpaceStats` (статистика выполнения задач)

**Что отображается:**
- Позиция в лидерборде (rank) - `leaguePosition` в общем списке, `chunkPosition` внутри чанка
- Имя пользователя (firstName)
- Уровень (level)
- Общий опыт (totalXp) - максимальный опыт среди всех пространств
- Лига пользователя (league) - для MVP все пользователи в первой лиге
- Период раунда: 30 дней с информацией о времени до конца раунда

**Логика чанков и перемешивания:**
1. Все пользователи сортируются по убыванию `totalXp`
2. Каждый раунд (30 дней) пользователи **детерминированно перемешиваются** между чанками
3. Перемешивание основано на:
   - Номере текущего раунда (раунды начинаются с 1 января 2024 года, каждый длится 30 дней)
   - Количестве пользователей
   - Используется seeded random для детерминированного перемешивания (Fisher-Yates shuffle)
4. Пользователи разделяются на чанки по 50 человек
5. Пагинация работает по чанкам: `page` = номер чанка (1, 2, 3...)

**Технические детали:**
- Seed для перемешивания: `currentRoundNumber * 1000000 + totalUsers`
- Это гарантирует, что каждый раунд пользователи перемешиваются по-разному, но одинаково для всех пользователей в один и тот же момент времени
- Чанк 1 = пользователи с индексами 0-49, чанк 2 = 50-99, и т.д.
- Каждый новый раунд (через 30 дней) пользователи снова перемешиваются и распределяются по чанкам

## Локальный лидерборд (лидерборд пространства)

**Кто отображается:**
- Все участники текущего активного пространства
- Включаются даже те участники, у которых еще нет записей в `UserSpaceStats` (они получают уровень 1, опыт 0)
- Пользователи сортируются по опыту в этом конкретном пространстве

**Что отображается:**
- Позиция в лидерборде пространства
- Имя пользователя
- Уровень в этом пространстве
- Опыт в этом пространстве
- Лига пользователя в этом пространстве
- Позиция в лиге

**Логика:**
- Получаются все участники пространства через `SpaceMember`
- Для каждого участника берется статистика из `UserSpaceStats` для этого пространства
- Если статистики нет - используется уровень 1, опыт 0
- Сортировка по убыванию опыта в пространстве
